<!-- FS head_custom v6: load compiled CSS + generate right-side TOC (Turbolinks-safe) -->
<meta name="fs-head-custom" content="v6">
<link rel="stylesheet" href="{{ '/assets/css/just-the-docs-custom.css' | relative_url }}">

<script>
(function () {
  function fsBuildPageToc() {
    const root = document.documentElement;

    // Remove any previous TOC (Turbolinks/Turbo navigation can re-use the same <head>)
    const old = document.getElementById('page-toc');
    if (old) old.remove();
    root.classList.remove('has-page-toc');

    // Prefer the real main content node
    const main =
      document.querySelector('#main-content') ||
      document.querySelector('main.main-content') ||
      document.querySelector('main') ||
      document.querySelector('.main-content') ||
      document.querySelector('article');

    if (!main) return;

    // Pick headings inside main content only
    const headings = Array.from(main.querySelectorAll('h2, h3'))
      .filter(h => !h.classList.contains('no_toc') && !h.closest('nav, aside, footer'));

    // Too few headings -> don't show TOC and don't change layout
    if (headings.length < 2) return;

    const used = new Set();
    const slugify = (s) => (s || '')
      .trim()
      .toLowerCase()
      .replace(/[\s]+/g, '-')
      .replace(/[^a-z0-9\-\u00A0-\uFFFF]/g, '');

    const ensureId = (el) => {
      let id = (el.id || '').trim();
      if (!id) {
        id = slugify(el.textContent) || 'section';
        let base = id, n = 2;
        while (used.has(id) || document.getElementById(id)) id = base + '-' + (n++);
        el.id = id;
      }
      used.add(id);
      return id;
    };

    const toc = document.createElement('nav');
    toc.id = 'page-toc';
    toc.className = 'page-toc';
    toc.setAttribute('aria-label', 'On this page');

    const title = document.createElement('div');
    title.className = 'page-toc-title';
    title.textContent = 'On this page';
    toc.appendChild(title);

    const ul = document.createElement('ul');
    ul.className = 'page-toc-list';

    headings.forEach(h => {
      const level = (h.tagName || '').toUpperCase();
      const id = ensureId(h);

      const li = document.createElement('li');
      li.className = level === 'H3' ? 'lvl-h3' : 'lvl-h2';

      const a = document.createElement('a');
      a.href = '#' + id;
      a.textContent = (h.textContent || '').trim();

      li.appendChild(a);
      ul.appendChild(li);
    });

    toc.appendChild(ul);

    // Put TOC next to the main content (better for sticky right sidebar)
    const wrap =
      document.querySelector('.main-content-wrap') ||
      (main.closest && main.closest('.main-content-wrap')) ||
      main.parentElement ||
      main;

    wrap.appendChild(toc);
    root.classList.add('has-page-toc');
  }

  function fsInit() {
    // Let layout settle (especially after Turbolinks swap)
    requestAnimationFrame(fsBuildPageToc);
  }

  document.addEventListener('DOMContentLoaded', fsInit);
  document.addEventListener('turbolinks:load', fsInit);
  document.addEventListener('turbolinks:render', fsInit);
  document.addEventListener('turbo:load', fsInit);
})();
</script>


<script>
(function () {
  function fsSyncExpanded() {
    document.querySelectorAll('.nav-list-item').forEach(li => {
      if (li.querySelector(':scope > .nav-list')) li.classList.add('has-children');
      if (li.classList.contains('active')) {
        let p = li.parentElement;
        while (p) {
          if (p.classList && p.classList.contains('nav-list-item')) p.classList.add('is-expanded');
          p = p.parentElement;
        }
      }
    });
  }
  document.addEventListener('DOMContentLoaded', fsSyncExpanded);
  document.addEventListener('turbolinks:load', fsSyncExpanded);
  document.addEventListener('turbolinks:render', fsSyncExpanded);
  document.addEventListener('turbo:load', fsSyncExpanded);
})();
</script>
