<script>
document.addEventListener('DOMContentLoaded', function () {
  // 1. 寻找主内容容器
  const main = document.querySelector('.main-content');
  const wrap = document.querySelector('.main-content-wrap');
  if (!main || !wrap) return;

  // 2. 抓取所有二级和三级标题
  const headings = Array.from(main.querySelectorAll('h2, h3'));
  if (headings.length < 2) return; // 标题太少则不生成

  // 3. 构建 TOC HTML
  const aside = document.createElement('aside');
  aside.id = 'page-toc';
  
  let tocHtml = '<div class="page-toc-title">On this page</div><ul class="page-toc-list">';
  headings.forEach((h, i) => {
    if (!h.id) h.id = 'section-' + i;
    const levelClass = h.tagName === 'H3' ? 'style="margin-left:15px; font-size:12px;"' : '';
    tocHtml += `<li ${levelClass}><a href="#${h.id}">${h.textContent}</a></li>`;
  });
  tocHtml += '</ul>';
  aside.innerHTML = tocHtml;

  // 4. 注入并开启布局
  wrap.classList.add('has-page-toc');
  wrap.appendChild(aside);

  // 5. 滚动高亮逻辑
  const links = aside.querySelectorAll('a');
  window.addEventListener('scroll', () => {
    let current = '';
    headings.forEach(h => {
      const top = h.getBoundingClientRect().top;
      if (top < 120) current = h.id;
    });
    links.forEach(a => {
      a.classList.remove('active');
      if (a.getAttribute('href') === '#' + current) a.classList.add('active');
    });
  }, { passive: true });
});
</script>
