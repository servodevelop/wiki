<!-- Custom head: load compiled CSS + generate right-side TOC + nav expand highlighting -->
<link rel="stylesheet" href="{{ '/assets/css/just-the-docs-custom.css' | relative_url }}">

<script>
document.addEventListener('DOMContentLoaded', function () {

  // ---------- 1) Right-side TOC (auto) ----------
  // If you already have a TOC, don't duplicate
  if (!document.getElementById('page-toc')) {
    const main = document.querySelector('.main-content');
    const wrap = document.querySelector('.main-content-wrap') || main;
    if (main) {
      const headings = Array.from(main.querySelectorAll('h2, h3, h4'));
      if (headings.length) {
        const used = new Set();
        const slugify = (s) => (s || '').trim().toLowerCase()
          .replace(/[\s]+/g, '-')
          .replace(/[^\w\-]+/g, '')
          .replace(/\-+/g, '-');

        function ensureId(h) {
          if (h.id) return h.id;
          const base = slugify(h.textContent) || 'section';
          let id = base, i = 2;
          while (used.has(id) || document.getElementById(id)) id = `${base}-${i++}`;
          h.id = id;
          used.add(id);
          return id;
        }

        const aside = document.createElement('aside');
        aside.id = 'page-toc';
        aside.className = 'page-toc';
        aside.innerHTML = '<div class="page-toc-title">On this page</div><ul class="page-toc-list"></ul>';

        const ul = aside.querySelector('.page-toc-list');
        headings.forEach(h => {
          const id = ensureId(h);
          const li = document.createElement('li');
          li.className = 'lvl-' + h.tagName.toLowerCase();
          const a = document.createElement('a');
          a.href = '#' + id;
          a.textContent = h.textContent;
          li.appendChild(a);
          ul.appendChild(li);
        });

        // Put TOC inside main-content so float/sticky behave nicely
        wrap.appendChild(aside);
      }
    }
  }

  // ---------- 2) Sidebar: mark expanded directory items ----------
  function syncExpanded() {
    document.querySelectorAll('.nav-list-item').forEach(li => li.classList.remove('is-expanded'));
    document.querySelectorAll('.nav-list-expander[aria-expanded="true"]').forEach(btn => {
      const li = btn.closest('.nav-list-item');
      if (li) li.classList.add('is-expanded');
    });
  }

  syncExpanded();

  // Listen to expander clicks to update state
  document.querySelectorAll('.nav-list-expander').forEach(btn => {
    btn.addEventListener('click', function () {
      // aria-expanded changes after click; wait one tick
      setTimeout(syncExpanded, 0);
    });
  });

});
</script>
