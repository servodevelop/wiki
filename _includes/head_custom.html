<!-- Custom head: load compiled CSS + generate right-side TOC + nav expand highlighting -->
<link rel="stylesheet" href="{{ '/assets/css/just-the-docs-custom.css' | relative_url }}">

<script>
document.addEventListener('DOMContentLoaded', function () {

  // ---------- 1) Right-side TOC (auto) ----------
  // If you already have a TOC, don't duplicate
  if (!document.getElementById('page-toc')) {
    const main =
      document.querySelector('#main-content') ||
      document.querySelector('main.main-content') ||
      document.querySelector('.main-content') ||
      document.querySelector('article');

    if (main) {
      const headings = Array.from(main.querySelectorAll('h2, h3, h4')).filter(h => {
        // ignore headings inside nav/aside/footer if any
        return !h.closest('nav, aside, footer');
      });

      if (headings.length) {
        const used = new Set();
        const slugify = (s) => (s || '').trim().toLowerCase()
          .replace(/[\s]+/g, '-')
          .replace(/[^a-z0-9\-\u00A0-\uFFFF]/g, '');

        const ensureId = (el) => {
          let id = el.id && el.id.trim();
          if (!id) {
            id = slugify(el.textContent) || 'section';
            let base = id, n = 2;
            while (used.has(id) || document.getElementById(id)) id = base + '-' + (n++);
            el.id = id;
          }
          used.add(id);
          return id;
        };

        const aside = document.createElement('aside');
        aside.id = 'page-toc';
        aside.className = 'page-toc';

        const title = document.createElement('div');
        title.className = 'page-toc-title';
        title.textContent = 'On this page';
        aside.appendChild(title);

        const ul = document.createElement('ul');
        ul.className = 'page-toc-list';

        headings.forEach(h => {
          const tag = (h.tagName || '').toLowerCase();
          const id = ensureId(h);

          const li = document.createElement('li');
          li.className = 'lvl-' + tag;

          const a = document.createElement('a');
          a.href = '#' + id;
          a.textContent = h.textContent;
          li.appendChild(a);
          ul.appendChild(li);
        });

        aside.appendChild(ul);

        // Place TOC as a sibling of the article content so it can sit on the right
        const wrap = document.querySelector('.main-content-wrap');
        if (wrap && main && wrap.contains(main)) {
          wrap.appendChild(aside); // sibling of .main-content
        } else {
          // Fallback: put it at the top of the content
          main.insertBefore(aside, main.firstElementChild);
        }

        // Only enable 2-column spacing when TOC actually exists
        document.documentElement.classList.add('has-page-toc');
      } else {
        document.documentElement.classList.remove('has-page-toc');
      }
    }
  }

  // ---------- 2) Sidebar: mark expanded directory items ----------
  function syncExpanded() {
    document.querySelectorAll('.nav-list-item').forEach(li => {
      if (li.querySelector(':scope > .nav-list')) li.classList.add('has-children');
      if (li.classList.contains('active')) {
        let p = li.parentElement;
        while (p) {
          if (p.classList && p.classList.contains('nav-list-item')) p.classList.add('is-expanded');
          p = p.parentElement;
        }
      }
    });
  }
  syncExpanded();
});
</script>
