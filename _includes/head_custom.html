<link rel="stylesheet" href="{{ '/assets/css/just-the-docs-custom.css' | relative_url }}">

<script>
/* Ctrl+K 聚焦搜索 */
document.addEventListener('keydown', function (e) {
  const isMac = navigator.platform.toUpperCase().includes('MAC');
  const k = (e.key || '').toLowerCase() === 'k';
  const mod = isMac ? e.metaKey : e.ctrlKey;
  if (mod && k) {
    e.preventDefault();
    const input = document.querySelector('#search-input') || document.querySelector('input[type="search"]');
    if (input) input.focus();
  }
});

/* 每页自动生成右侧 TOC（h2/h3） */
document.addEventListener('DOMContentLoaded', function () {
  const main = document.querySelector('.main-content');
  const wrap = document.querySelector('.main-content-wrap');
  if (!main || !wrap) return;

  // 如果某页 front matter 写 toc: false，可关闭
  // （Jekyll 会把 page 变量渲染到 HTML 中）
  try {
    const tocDisabled = {{ page.toc == false | jsonify }};
    if (tocDisabled) return;
  } catch (e) {}

  const headings = Array.from(main.querySelectorAll('h2, h3'))
    .filter(h => !h.classList.contains('no_toc'));

  if (headings.length === 0) return;
  if (document.getElementById('page-toc')) return;

  const slugify = (s) => (s || '').trim().toLowerCase()
    .replace(/[\s]+/g, '-')
    .replace(/[^\w\-]+/g, '')
    .replace(/\-+/g, '-');

  const used = new Set();

  const tocBox = document.createElement('aside');
  tocBox.id = 'page-toc';
  tocBox.className = 'page-toc';
  tocBox.innerHTML = '<div class="page-toc-title">On this page</div><ul class="page-toc-list"></ul>';

  const list = tocBox.querySelector('.page-toc-list');

  headings.forEach(h => {
    let id = h.id;
    if (!id) {
      const base = slugify(h.textContent) || 'section';
      let uniq = base;
      let i = 2;
      while (used.has(uniq) || document.getElementById(uniq)) uniq = `${base}-${i++}`;
      id = uniq;
      h.id = id;
    }
    used.add(id);

    const li = document.createElement('li');
    li.className = `lvl-${h.tagName.toLowerCase()}`;

    const a = document.createElement('a');
    a.href = `#${id}`;
    a.textContent = h.textContent;

    li.appendChild(a);
    list.appendChild(li);
  });

  wrap.appendChild(tocBox);
});
</script>
